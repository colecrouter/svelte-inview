name: Release and Publish

on:
  push:
    paths:
      - 'package.json'

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Filter changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            package:
              - 'package.json'

      - name: Exit if package.json not changed
        if: steps.filter.outputs.package != 'true'
        run: |
          echo "No changes in package.json; skipping release."
          exit 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org/'

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Get package version
        id: pkg
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Version: $VERSION"
          echo "::set-output name=VERSION::$VERSION"

      - name: Create a Release
        uses: elgohr/Github-Release-Action@v5
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          title: Release v${{ steps.pkg.outputs.VERSION }}
          tag: v${{ steps.pkg.outputs.VERSION }}

      - name: Publish to npm
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
